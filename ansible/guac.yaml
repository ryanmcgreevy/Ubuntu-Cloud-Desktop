---
- name: Install guacamole and tomcat
  hosts: tag_Name_fresh_install
  become: true
  gather_facts: false

  tasks:
    - name: Install apt packages
      become: true
      apt:
          update_cache: true
          cache_valid_time: 7200
          pkg:
              #guacd seems to not be in ubuntu 25.04 repos, must build from src...
              #- guacd
              - default-jdk
              - apache2
              #the following are only needed if building guacamole-server
              - libcairo2-dev
              - libjpeg-turbo8-dev
              - libpng-dev
              - libtool-bin
              - uuid-dev
              - freerdp3-dev
              - libvncserver-dev

    - name : Copy guacamole server files
      unarchive:
          src: guacamole-server.tar.gz
          dest: /home/ubuntu

    - name : generate configure file for guac server
      command: 
        cmd: autoreconf -fi
        chdir: /home/ubuntu/guacamole-server

    - name : configure guac server
      command: 
        cmd: ./configure --with-init-dir=/etc/init.d
        chdir: /home/ubuntu/guacamole-server

    - name : make and install guac server
      community.general.make:
        chdir: /home/ubuntu/guacamole-server
        target: install
      become: true

    - name : run ldconfig to load new guac shared libraries
      command:
        cmd: ldconfig
      become: true

    - name : remove guac server source files
      ansible.builtin.file:
        path: /home/ubuntu/guacamole-server
        state: absent

    - name: Ensure group "tomcat" exists
      ansible.builtin.group:
        name: tomcat
        state: present
        system: true

    - name: Add the user 'tomcat' with a specific uid and a primary group of 'tomcat'
      ansible.builtin.user:
        name: tomcat
        comment: tomcat
        uid: 1040
        group: tomcat
        home: /usr/share/tomcat
        shell: /bin/false

    - name: Create a tomcat directory if it does not exist
      ansible.builtin.file:
        path: /usr/share/tomcat
        state: directory
        mode: '0777'
        owner: ubuntu
        group: ubuntu
    #WARNING: make sure the archive file in the repo is first uncompressed and the top level directory changed to /tomcat
    #This needs to happen whenever a new version of tomcat is being installed, until the process of renaming the file is automated
    - name: Copy tomcat files
      unarchive:
          src: tomcat.tar.gz
          dest: /usr/share/
          owner: tomcat
          group: tomcat
          mode: '777'

    - name: Change ownership of tomcat directory
      ansible.builtin.file:
        path: /usr/share/tomcat
        owner: tomcat
        group: tomcat
        recurse: yes
        state: directory

    - name: Copy tomcat service file
      copy:
          src: tomcat.service
          dest: /etc/systemd/system/
          owner: ubuntu
          group: ubuntu
          mode: '0664'

    - name: Enable service tomcat, and not touch the state
      ansible.builtin.service:
        name: tomcat.service
        enabled: yes
  
    - name: Just force systemd to reread configs (2.4 and above)
      ansible.builtin.systemd_service:
        daemon_reload: true

    - name: start service tomcat in all cases
      ansible.builtin.service:
         name: tomcat.service
         state: started

    - name: Create a guacamole directory if it does not exist
      ansible.builtin.file:
        path: /etc/guacamole
        state: directory

    - name: Copy guacamole war file
      copy:
          src: guacamole.war
          dest: /etc/guacamole/guacamole.war

    - name: make a symlkink to guacamole war file
      file:
        src: /etc/guacamole/guacamole.war
        dest: /usr/share/tomcat/webapps/guacamole.war
        state: link

    - name: Copy guacamole home file
      copy:
          src: tomcat
          dest: /etc/default/tomcat

    - name: Copy guacamole properties file
      copy:
          src: guacamole.properties
          dest: /etc/guacamole/

    - name: make a symlkink to guacamole
      file:
        src: /etc/guacamole/
        dest: /usr/share/tomcat/.guacamole
        state: link

    - name: Copy apache conf for guacamole file
      copy:
          src: guacamole.conf
          dest:  /etc/apache2/sites-available/

    - name: Enable the Apache2 module proxy
      community.general.apache2_module:
        state: present
        name: proxy

    - name: Enable the Apache2 module proxy_http
      community.general.apache2_module:
        state: present
        name: proxy_http

    - name: Enable the Apache2 module proxy_balancer
      community.general.apache2_module:
        state: present
        name: proxy_balancer

    - name: Enable the Apache2 module lbmethod_byrequests
      community.general.apache2_module:
        state: present
        name: lbmethod_byrequests

    - name: add guacamole apache site
      command: a2ensite guacamole

    - name: Remove apache default site
      command: a2dissite 000-default.conf

    - name: Restart service apache2 in all cases
      ansible.builtin.service:
        name: apache2
        state: restarted

    - name: Restart service guacd in all cases
      ansible.builtin.service:
        name: guacd
        state: restarted

    - name: Unconditionally reboot the machine with all defaults
      ansible.builtin.reboot:
